import React, { useState, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { 
  Package, 
  CheckCircle, 
  Clock, 
  Building2,
  AlertTriangle,
  TrendingUp,
  Layers,
  DollarSign,
  Plus,
  Eye,
  UserCheck
} from 'lucide-react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import MetricCard from '../components/shared/MetricCard';
import FilterBar from '../components/shared/FilterBar';
import ExportButton from '../components/shared/ExportButton';
import DataTable from '../components/shared/DataTable';
import ChartCard from '../components/shared/ChartCard';
import StoreForm from '../components/forms/StoreForm';

export default function StoreDashboard() {
  const [filters, setFilters] = useState({});
  const [activeTab, setActiveTab] = useState('overview');
  const [selectedItem, setSelectedItem] = useState(null);
  const [showAddDialog, setShowAddDialog] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);

  useEffect(() => {
    base44.auth.me().then(setCurrentUser).catch(() => {});
  }, []);

  const { data: records = [], isLoading, refetch } = useQuery({
    queryKey: ['store-inventory'],
    queryFn: () => base44.entities.StoreInventory.list('-created_date', 500),
    refetchInterval: 30000,
  });

  useEffect(() => {
    const unsubscribe = base44.entities.StoreInventory.subscribe(() => {
      refetch();
    });
    return unsubscribe;
  }, [refetch]);

  const filteredRecords = records.filter(record => {
    if (filters.search && !record.item_name?.toLowerCase().includes(filters.search.toLowerCase()) &&
        !record.vendor?.toLowerCase().includes(filters.search.toLowerCase())) {
      return false;
    }
    if (filters.vendor && filters.vendor !== 'all' && record.vendor !== filters.vendor) return false;
    if (filters.category && filters.category !== 'all' && record.category !== filters.category) return false;
    if (filters.confirmed && filters.confirmed !== 'all') {
      const isConfirmed = record.is_confirmed;
      if (filters.confirmed === 'confirmed' && !isConfirmed) return false;
      if (filters.confirmed === 'pending' && isConfirmed) return false;
    }
    if (filters.date) {
      const recordDate = new Date(record.created_date).toDateString();
      const filterDate = new Date(filters.date).toDateString();
      if (recordDate !== filterDate) return false;
    }
    return true;
  });

  // Metrics
  const metrics = {
    totalItems: filteredRecords.length,
    totalReceived: filteredRecords.reduce((sum, r) => sum + (r.quantity_received || 0), 0),
    totalValue: filteredRecords.reduce((sum, r) => sum + ((r.quantity_received || 0) * (r.unit_price || 0)), 0),
    pendingConfirmations: filteredRecords.filter(r => !r.is_confirmed).length,
    confirmedItems: filteredRecords.filter(r => r.is_confirmed).length,
    uniqueVendors: [...new Set(filteredRecords.map(r => r.vendor))].length,
    discrepancies: filteredRecords.filter(r => r.quantity_requested && r.quantity_received !== r.quantity_requested).length,
  };

  const vendors = [...new Set(records.map(r => r.vendor))].filter(Boolean);
  const categories = ['Raw Materials', 'Office Supplies', 'Equipment', 'Consumables', 'Other'];

  // Charts
  const vendorData = vendors.slice(0, 10).map(vendor => {
    const vendorRecords = filteredRecords.filter(r => r.vendor === vendor);
    return {
      name: vendor.length > 15 ? vendor.substring(0, 15) + '...' : vendor,
      quantity: vendorRecords.reduce((sum, r) => sum + (r.quantity_received || 0), 0),
      value: vendorRecords.reduce((sum, r) => sum + ((r.quantity_received || 0) * (r.unit_price || 0)), 0),
    };
  });

  const categoryData = categories.map(cat => ({
    name: cat,
    value: filteredRecords.filter(r => r.category === cat).reduce((sum, r) => sum + (r.quantity_received || 0), 0),
  })).filter(d => d.value > 0);

  const confirmationData = [
    { name: 'Confirmed', value: metrics.confirmedItems },
    { name: 'Pending', value: metrics.pendingConfirmations },
  ].filter(d => d.value > 0);

  const handleConfirm = async (item) => {
    await base44.entities.StoreInventory.update(item.id, {
      is_confirmed: true,
      confirmation_date: new Date().toISOString(),
    });
    refetch();
    setSelectedItem(null);
  };

  const handleMarkAsSeen = async (item) => {
    if (!currentUser) return;
    const seenBy = item.seen_by || [];
    if (!seenBy.includes(currentUser.email)) {
      await base44.entities.StoreInventory.update(item.id, {
        seen_by: [...seenBy, currentUser.email],
        seen_count: seenBy.length + 1,
      });
      refetch();
    }
  };

  const handleMarkAsFixed = async (item) => {
    if (!currentUser) return;
    await base44.entities.StoreInventory.update(item.id, {
      fixed_by: currentUser.email,
      fixed_date: new Date().toISOString(),
    });
    refetch();
    setSelectedItem(null);
  };

  const filterConfig = [
    { key: 'search', type: 'search', placeholder: 'Search item or vendor...' },
    { key: 'vendor', type: 'select', label: 'Vendors', placeholder: 'Vendor', options: vendors.map(v => ({ value: v, label: v })) },
    { key: 'category', type: 'select', label: 'Categories', placeholder: 'Category', options: categories.map(c => ({ value: c, label: c })) },
    { key: 'confirmed', type: 'select', label: 'Status', placeholder: 'Confirmation', options: [
      { value: 'confirmed', label: 'Confirmed' },
      { value: 'pending', label: 'Pending' },
    ]},
    { key: 'date', type: 'date', placeholder: 'Select date' },
  ];

  const columns = [
    { key: 'item_name', label: 'Item Name' },
    { key: 'category', label: 'Category', type: 'status' },
    { key: 'quantity_received', label: 'Qty Received', type: 'number' },
    { key: 'quantity_requested', label: 'Qty Requested', type: 'number' },
    { key: 'vendor', label: 'Vendor' },
    { key: 'unit_price', label: 'Unit Price', type: 'currency' },
    { key: 'is_confirmed', label: 'Confirmed', type: 'status', render: (val) => val ? 'Yes' : 'Pending' },
    { key: 'seen_count', label: 'Seen By', render: (val) => `${val || 0} people` },
    { key: 'fixed_by', label: 'Fixed By', render: (val) => val || '-' },
    { key: 'storekeeper', label: 'Storekeeper' },
    { key: 'time_received', label: 'Time Received', type: 'datetime' },
    { key: 'created_date', label: 'Date', type: 'date' },
  ];

  const exportColumns = columns.map(c => ({
    key: c.key,
    label: c.label,
    accessor: (row) => c.render ? c.render(row[c.key]) : row[c.key],
  }));

  if (isLoading) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center">
        <div className="animate-pulse text-slate-500">Loading dashboard...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50">
      <div className="bg-white border-b border-slate-200 px-6 py-5">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold text-slate-900">Store Inventory</h1>
            <p className="text-sm text-slate-500 mt-1">Track items received and confirm stock levels</p>
          </div>
          <div className="flex items-center gap-3">
            <div className="flex items-center gap-2 text-sm text-slate-500">
              <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse" />
              Real-time
            </div>
            <ExportButton data={filteredRecords} filename="store-inventory" columns={exportColumns} />
            <Button onClick={() => setShowAddDialog(true)}>
              <Plus className="w-4 h-4 mr-2" />
              Add Item
            </Button>
          </div>
        </div>
      </div>

      <div className="p-6 space-y-6">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <MetricCard title="Total Items" value={metrics.totalItems.toLocaleString()} icon={Package} variant="primary" />
          <MetricCard title="Confirmed" value={metrics.confirmedItems} icon={CheckCircle} variant="success" />
          <MetricCard title="Pending" value={metrics.pendingConfirmations} icon={Clock} variant={metrics.pendingConfirmations > 0 ? "warning" : "default"} />
          <MetricCard title="Discrepancies" value={metrics.discrepancies} icon={AlertTriangle} variant={metrics.discrepancies > 0 ? "danger" : "default"} />
        </div>

        <FilterBar
          filters={filterConfig}
          values={filters}
          onChange={setFilters}
          onReset={() => setFilters({})}
        />

        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="bg-white border border-slate-200">
            <TabsTrigger value="overview">Overview</TabsTrigger>
            <TabsTrigger value="records">Records</TabsTrigger>
            <TabsTrigger value="analytics">Analytics</TabsTrigger>
          </TabsList>

          <TabsContent value="overview" className="mt-6">
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <ChartCard
                title="Inventory by Category"
                subtitle="Quantity distribution"
                type="pie"
                data={categoryData}
                dataKey="value"
              />
              <ChartCard
                title="Confirmation Status"
                subtitle="Confirmed vs Pending"
                type="pie"
                data={confirmationData}
                dataKey="value"
                colors={['#10b981', '#f59e0b']}
              />
              <ChartCard
                title="Top Vendors"
                subtitle="By quantity received"
                type="bar"
                data={vendorData.slice(0, 5)}
                dataKey="quantity"
              />
            </div>
          </TabsContent>

          <TabsContent value="records" className="mt-6">
            <DataTable
              columns={columns}
              data={filteredRecords}
              onRowClick={setSelectedItem}
              highlightCondition={(row) => !row.is_confirmed || (row.quantity_requested && row.quantity_received !== row.quantity_requested)}
              emptyMessage="No inventory records found"
            />
          </TabsContent>

          <TabsContent value="analytics" className="mt-6">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <ChartCard
                title="Vendor Performance"
                subtitle="Total value by vendor"
                type="bar"
                data={vendorData}
                dataKey="value"
                colors={['#8b5cf6']}
              />
              <ChartCard
                title="Stock Levels by Category"
                subtitle="Quantity received"
                type="bar"
                data={categoryData}
                dataKey="value"
                colors={['#06b6d4']}
              />
            </div>
          </TabsContent>
        </Tabs>
      </div>

      {/* Item Detail Dialog */}
      <Dialog open={!!selectedItem} onOpenChange={() => setSelectedItem(null)}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle>Item Details</DialogTitle>
          </DialogHeader>
          {selectedItem && (
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-slate-500">Item Name</p>
                  <p className="font-medium">{selectedItem.item_name}</p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Category</p>
                  <p className="font-medium">{selectedItem.category || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Vendor</p>
                  <p className="font-medium">{selectedItem.vendor}</p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Quantity Received</p>
                  <p className="font-medium">{selectedItem.quantity_received}</p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Unit Price</p>
                  <p className="font-medium">₦{selectedItem.unit_price?.toLocaleString() || '-'}</p>
                </div>
                <div>
                  <p className="text-sm text-slate-500">Total Value</p>
                  <p className="font-medium">₦{((selectedItem.quantity_received || 0) * (selectedItem.unit_price || 0)).toLocaleString()}</p>
                </div>
              </div>
              {selectedItem.remarks && (
                <div>
                  <p className="text-sm text-slate-500">Remarks</p>
                  <p className="font-medium">{selectedItem.remarks}</p>
                </div>
              )}
              
              {selectedItem.seen_by && selectedItem.seen_by.length > 0 && (
                <div>
                  <p className="text-sm text-slate-500 mb-2">Seen By ({selectedItem.seen_by.length})</p>
                  <div className="flex flex-wrap gap-2">
                    {selectedItem.seen_by.map((email, idx) => (
                      <Badge key={idx} variant="outline" className="text-xs">
                        <Eye className="w-3 h-3 mr-1" />
                        {email}
                      </Badge>
                    ))}
                  </div>
                </div>
              )}

              {selectedItem.fixed_by && (
                <div className="p-3 bg-emerald-50 rounded-lg">
                  <p className="text-sm font-medium text-emerald-700 flex items-center gap-2">
                    <UserCheck className="w-4 h-4" />
                    Fixed by: {selectedItem.fixed_by}
                  </p>
                  <p className="text-xs text-emerald-600 mt-1">
                    {new Date(selectedItem.fixed_date).toLocaleString()}
                  </p>
                </div>
              )}

              <div className="flex gap-2">
                <Button onClick={() => handleMarkAsSeen(selectedItem)} variant="outline" className="flex-1">
                  <Eye className="w-4 h-4 mr-2" />
                  Mark as Seen
                </Button>
                {!selectedItem.fixed_by && (
                  <Button onClick={() => handleMarkAsFixed(selectedItem)} variant="outline" className="flex-1">
                    <UserCheck className="w-4 h-4 mr-2" />
                    Mark as Fixed
                  </Button>
                )}
              </div>
              
              {!selectedItem.is_confirmed && (
                <Button onClick={() => handleConfirm(selectedItem)} className="w-full">
                  <CheckCircle className="w-4 h-4 mr-2" />
                  Confirm Receipt
                </Button>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>

      <Dialog open={showAddDialog} onOpenChange={setShowAddDialog}>
        <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Add Store Inventory Item</DialogTitle>
          </DialogHeader>
          <StoreForm
            onSubmit={async (data) => {
              await base44.entities.StoreInventory.create(data);
              refetch();
              setShowAddDialog(false);
            }}
            onCancel={() => setShowAddDialog(false)}
          />
        </DialogContent>
      </Dialog>
    </div>
  );
}
